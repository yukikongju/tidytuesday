---
title: "Exploring the survivors dataset"
output: html_document
---

```{r , include=FALSE}

# system('sudo apt install libcairo2-dev')
# devtools::install_github("hrbrmstr/hrbrthemes")

library(tmap)
library(maps)
library(usmap)
library(spData)
# library(spDataLarge)
library(sf)
library(raster)
library(leaflet)
library(survivoR)
library(ggplot2)
library(lubridate)
library(hrbrthemes)
library(plotly)
library(tidyr)
library(dplyr)
library(stringr)

castaway_details <- survivoR::castaway_details
castaways <- survivoR::castaways
challenge_description <- survivoR::challenge_description
challenge_results <- survivoR::challenge_results
challenges <- survivoR::challenges
confessionals <- survivoR::confessionals
hidden_idols <- survivoR::hidden_idols
jury_votes <- survivoR::jury_votes
season_palettes <- survivoR::season_palettes
season_summary <- survivoR::season_summary
tribe_colours <- survivoR::tribe_colours
tribe_mapping <- survivoR::tribe_mapping
viewers <- survivoR::viewers
vote_history <- survivoR::vote_history
```


# Data Wrangling


```{r}


```


Inspiration: https://gradientdescending.com/survivor-data-from-the-tv-series-in-r/

# Survivors Location

### Where do season take place?

```{r}
locations <- season_summary %>% 
  group_by(country) %>% 
  transmute(count=n()) %>% 
  unique()



locations
```


# Castaways - Exploring Players Stats

### Where do players come from?

```{r }

# states
states <- castaways %>% 
  distinct(castaway_id, .keep_all = TRUE) %>% 
  group_by(state) %>% 
  transmute(count=n()) %>% 
  unique() %>% 
  arrange(desc(count))

# city
participants_city <- castaways %>% 
  distinct(castaway_id, .keep_all = TRUE) %>% 
  group_by(city) %>% 
  transmute(count=n()) %>% 
  unique() %>% 
  arrange(desc(count))


# show city on map

cast_locations <- castaways %>% 
  group_by(city, state) %>%
  transmute(count=n()) %>% 
  unique() %>% 
  arrange(city) 

cast_locations

cities <- us.cities %>% 
  rename(state = country.etc) %>% 
  mutate(city=word(name, 1,-2)) %>% 
  select(city, pop, lat, long, state) %>% 
  right_join(cast_locations, by=c("city")) %>% 
  drop_na() %>% 
  # select(long, lat, city) %>% 
  rename(lon=long)

cities_t <- usmap_transform(cities)

p <- plot_usmap() +
  geom_point(data = cities_t, aes(x=x, y=y, label=city, size=count), 
             color = 'purple', alpha=.25) +
  labs(title = "Where do Survivor Contestants come from?", size = "Count")


ggplotly(p)

```


### What do survivor player do for a living?


### Who played the most

```{r}
participations_count <- castaways %>% 
  group_by(castaway_id, full_name) %>%
  summarise(num_participations=n()) %>% 
  arrange(desc(num_participations))
```

### Memorable players - Played at least two seasons or made the jury

```{r, echo=FALSE}

num_players <- as.integer(nrow(castaways %>% select(castaway_id) %>% distinct() %>% arrange(castaway_id)))

went_far <- castaways %>% 
  filter(!is.na(jury_status) | (result %in% c('Sole Survivor', 'Runner-up'))) %>% 
  group_by(castaway_id, full_name) %>% 
  summarise(has_made_jury=TRUE) 

has_made_jury <- castaways %>% 
  select(castaway_id, full_name) %>% 
  distinct() %>% 
  left_join(went_far) %>% 
  mutate(has_made_jury=ifelse(is.na(has_made_jury), FALSE, TRUE)) %>% 
  arrange(castaway_id)

players <- castaways %>% 
  select(castaway_id, full_name) %>% 
  left_join(participations_count, by=c("castaway_id", "full_name")) %>% 
  left_join(has_made_jury, by=c("castaway_id", "full_name"))

```

```{r, echo=FALSE}

mediocre_players <- players %>% 
  filter(has_made_jury==FALSE & (num_participations == 1))

okay_players <- players %>% 
  filter((has_made_jury==FALSE) & (num_participations > 1)) 

memorable_players <- players %>% 
  filter((has_made_jury==TRUE) & (num_participations > 1))

winners <- castaways %>% 
  filter(result == 'Sole Survivor')


# goats <- players %>% 
#   filter((has_made_jury==TRUE) & (num_participations > 2)) 


```



# Challenges 

### Types of challenges

```{r }
within(challenge_description, rm(challenge_id, challenge_name)) %>% 
  summarise_each( funs = mean) %>% 
  sapply(round, 3) * 100
```

### Challenge Beasts and what they are good at

```{r}

individual_challenges <- challenge_results %>% 
  filter(outcome_type == 'Individual')

immunity_idols_count <- castaways %>% 
  select(season_name, full_name, castaway_id, immunity_idols_won, result, season) %>% 
  arrange(season, desc(immunity_idols_won))

immunity_idols_count

# TODO: count each type of challenge won 



```


### Radar Chart - Evaluating Players skillset with radar chart

We are evaluating player based on:
1) Social Game: ability to avoid getting voted at at tribal
2) Challenge Ability: immunity challenges won
3) 

```{r}

```


# Winners - 

### Winners confessionals vs rest of people

```{r , echo=FALSE}
# num_confessionals <- aggregate(confessionals$confessional_count, by=list(Season=confessionals$season_name, Cast=confessionals$castaway, ID = confessionals$castaway_id), FUN=sum)

num_confessionals <- confessionals %>% 
  semi_join(castaways, by ="castaway_id") %>% 
  group_by(season_name, castaway, castaway_id) %>% 
  summarise(Confessional_Count=sum(confessional_count)) %>% 
  arrange(desc(Confessional_Count))

confessions <- num_confessionals %>% 
  inner_join(castaways, by=c("castaway_id", "season_name", "castaway")) %>% 
  select(c("season_name",  "full_name", "Confessional_Count", "result", "personality_type", "total_votes_received", "immunity_idols_won", "castaway_id", "season")) %>% 
  arrange(season, desc(Confessional_Count)) 

# TODO: add ranking


num_confessionals %>% 
  ggplot(aes(x=, y=Confessional_Count))
```


### Winners Personality Types (vs norm)

Il y a 16 types de personnalités. On s'attend à ce que le nombre de personnes dans chaque classe représente autour de 1/16 ie 6.25%

```{r , echo=FALSE}


personality_count <- castaways %>% group_by(personality_type) %>% summarise(count= n()) 
personality_count$perc <- personality_count$count / nrow(castaways) * 100 

# sort winners by introvert and extrovert
introvert_count <- function(df) {
  df$is_introvert <- ifelse(substr(df$personality_type,1,1) == "I", TRUE, FALSE)
  introvert_count <- df %>% group_by(is_introvert) %>% summarise(count = n())
  return(introvert_count)
}

introvert_count(winners)
introvert_count(castaways)

```


### Winners votes out 

```{r , echo=FALSE}

plot_lm <- function(x, y) {
  reg <- lm(y~x)
  summary(reg)
  plot(x, y)
  abline(reg, col='red')
}

plot_lm(castaways$day, castaways$total_votes_received)

```

Le nombre de votes n'est pas un bon prédicteur pour déterminer le gagnant

### Final Tribal Results

```{r, echo=FALSE}

season_results <- castaways %>% 
  select(season_name, full_name, castaway_id,immunity_idols_won, total_votes_received, season) %>% 
  rename(finalist_id = castaway_id)  

final_tribal_results <- jury_votes %>% 
  group_by(finalist_id, season_name) %>% 
  summarise(votes=sum(vote)) %>% 
  arrange(season_name) %>% 
  inner_join(season_results, by=c("finalist_id", "season_name")) %>% 
  arrange(season, desc(votes)) %>% 
  relocate(c(season_name, full_name))
  
final_tribal_results

```



### Immunity Idols

```{r}
plot_lm(castaways$day, castaways$immunity_idols_won)

castaways$is_winner = ifelse(castaways$result == 'Sole Survivor', TRUE, FALSE)

plot(castaways$day, castaways$immunity_idols_won, col = ifelse(castaways$result == 'Sole Survivor', "green", "black"))

```

# Show Rating - 

Has the show popularity decline/quality? (sort by color)

```{r}
p <- viewers %>% 
  ggplot(aes(x=episode_date, y=viewers)) +
    geom_area(fill="#69b3a2", alpha=0.5) +
    geom_line(color="#69b3a2") +
    ylab("Viewers (millions") + 
    xlab("Date") +
    theme_ipsum() 

ggplotly(p)

```

### IMDB Rating

```{r}

```

# Jury


### Voting History

```{r}
# TODO: add final tribal
voting_results <- vote_history %>% 
  distinct(season_name, order, voted_out)

voting_results


# individual tribal concil results
contestants_by_season <- castaways %>% 
  select(season_name, full_name, castaway_id, season)

tribal_results <- vote_history %>% 
  group_by(season, day, vote_id) %>% 
  summarise(votes=n()) %>% 
  rename(castaway_id = vote_id) %>%
  inner_join(contestants_by_season, by=c("season", "castaway_id")) %>% 
  relocate(c("season_name", "castaway_id", "full_name", "day", "votes")) %>% 
  arrange(season, day, desc(votes))

tribal_results

```

### Who voted correctly

```{r, echo=FALSE}
# Problem: with voted_correctly creates NA?
has_voted_correctly <- vote_history %>% 
  select(season_name, castaway_id, season, vote_id, voted_out_id) %>% 
  mutate(has_voted_correctly=ifelse(vote_id == voted_out_id, 1, 0)) %>% 
  select(!c("vote_id", "voted_out_id")) %>%
  inner_join(contestants_by_season, by=c("season_name", "castaway_id", "season")) %>% 
  arrange(season, desc(has_voted_correctly)) %>% 
  group_by(season_name, castaway_id, season, full_name) %>% 
  transmute(num_votes = n(), voted_correctly = sum(has_voted_correctly))

has_voted_correctly

```


## Crazy Voting Outcomes

```{r}
# Tie
vote_history %>% 
  filter((voted_out %in% c('Tie', 'Tie2')))
  

# Idol plays and nullifiers
vote_history %>% 
  # group_by(season, episode, day) %>%
  filter((nullified==TRUE) | (immunity=='Hidden'))

```



